<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®é”äºº - æ—¥ç³»å¯æ„›æ—…è¡Œè¦åŠƒ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Varela Round', 'Quicksand', sans-serif;
            background-color: #fdf2f8; /* pink-50 */
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(300deg);
            cursor: pointer;
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
    </style>
</head>
<body class="min-h-screen text-gray-700">

    <div id="app" class="h-screen flex flex-col overflow-hidden">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹æ¸²æŸ“ -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- åˆå§‹åŒ–é…ç½® ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'travel-planner-v2';
        const apiKey = ""; // Gemini API Key

        // --- å…¨åŸŸç‹€æ…‹ç®¡ç† ---
        let state = {
            user: null,
            savedTrips: [],
            step: 'landing', // landing, setup, hotels, loading, dashboard
            currentTripId: null,
            tripInfo: {
                destination: '',
                purpose: '',
                startDate: '',
                endDate: '',
                flightOut: '',
                flightIn: ''
            },
            hotels: [],
            itinerary: null,
            selectedDay: null,
            selectedEvent: null,
            loadingMsg: 'æ­£åœ¨ç²å–æœ€æ–°è³‡è¨Š...',
            showAddModal: false,
            activeDayToAdd: null
        };

        // --- æ ¸å¿ƒé‚è¼¯ ---

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        function setupListeners() {
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    const tripsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'trips');
                    onSnapshot(tripsCol, (snapshot) => {
                        state.savedTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        render();
                    }, (err) => console.error("Firestore Error:", err));
                }
                render();
            });
        }

        async function saveTripToCloud() {
            if (!state.user) return;
            const saveTitle = `${state.tripInfo.destination}_${state.tripInfo.purpose}_${state.tripInfo.startDate}è‡³${state.tripInfo.endDate}`;
            const tripId = state.currentTripId || crypto.randomUUID();
            state.currentTripId = tripId;

            const tripDoc = {
                title: saveTitle,
                tripInfo: state.tripInfo,
                hotels: state.hotels,
                itinerary: state.itinerary,
                updatedAt: serverTimestamp()
            };

            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'trips', tripId), tripDoc);
            } catch (err) {
                console.error("Save Error:", err);
            }
        }

        async function generateItinerary() {
            const start = new Date(state.tripInfo.startDate);
            const end = new Date(state.tripInfo.endDate);
            const daysCount = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;

            state.step = 'loading';
            state.loadingMsg = `æ­£åœ¨æŸ¥è©¢èˆªç­ ${state.tripInfo.flightOut} çš„æœ€æ–°ç‹€æ…‹...`;
            render();

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…è¡Œè¦åŠƒå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™ç”Ÿæˆä¸€å€‹è©³ç´°è¡Œç¨‹ JSONï¼š
            ç›®çš„åœ°ï¼š${state.tripInfo.destination}ï¼Œå¤©æ•¸ï¼š${daysCount} å¤©ã€‚
            é…’åº—å®‰æ’ï¼š${state.hotels.map(h => `ç¬¬${h.night}æ™š: ${h.isTBD ? 'å¾…å®š' : h.name}`).join(', ')}
            è¦æ±‚ï¼š1. ç¬¬ä¸€å¤©åŒ…å«æ©Ÿå ´é™è½ï¼Œæœ€å¾Œä¸€å¤©åŒ…å«å›ç¨‹ã€‚2. ä¸èµ°å›é ­è·¯ã€‚
            è¼¸å‡ºæ ¼å¼ï¼š{"days": [{"dayNum": 1, "events": [{"time": "HH:MM", "type": "attraction", "title": "åç¨±", "desc": "ç°¡ä»‹", "lat": 0, "lng": 0}]}], "hotelSuggestions": []}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                state.itinerary = JSON.parse(data.candidates[0].content.parts[0].text);
                await saveTripToCloud();
                state.step = 'dashboard';
                render();
            } catch (err) {
                state.step = 'setup';
                alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
                render();
            }
        }

        // --- æ¸²æŸ“å¼•æ“ ---

        function render() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = '';

            switch (state.step) {
                case 'landing': renderLanding(appDiv); break;
                case 'setup': renderSetup(appDiv); break;
                case 'hotels': renderHotels(appDiv); break;
                case 'loading': renderLoading(appDiv); break;
                case 'dashboard': renderDashboard(appDiv); break;
            }
        }

        function renderLanding(container) {
            container.className = "min-h-screen bg-pink-50 p-6 flex flex-col items-center justify-center";
            container.innerHTML = `
                <div class="w-full max-w-xl bg-white rounded-[50px] shadow-2xl p-10 border-4 border-white text-center">
                    <div class="w-24 h-24 bg-pink-100 rounded-[30px] flex items-center justify-center mx-auto mb-6 shadow-inner">
                        <i class="fa-solid fa-sparkles text-pink-400 text-5xl animate-pulse"></i>
                    </div>
                    <h1 class="text-4xl font-black text-pink-400 mb-2 tracking-tight">æ—…ã®é”äºº</h1>
                    <p class="text-pink-300 font-bold mb-10">é–‹å§‹è¦åŠƒä½ çš„å°ˆå±¬å¯æ„›æ—…ç¨‹å§ï¼ğŸŒ¸</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button id="btn-new-trip" class="group bg-pink-400 text-white p-8 rounded-[35px] shadow-lg hover:bg-pink-500 transition-all flex flex-col items-center gap-4 active:scale-95">
                            <div class="bg-white/20 p-4 rounded-full group-hover:rotate-12 transition-transform">
                                <i class="fa-solid fa-plus text-3xl"></i>
                            </div>
                            <span class="text-xl font-black">æ–°å»ºæ—…è¡Œæº–å‚™</span>
                        </button>
                        <div class="bg-orange-50 p-6 rounded-[35px] border-2 border-orange-100 flex flex-col">
                            <h3 class="text-orange-400 font-black flex items-center gap-2 mb-4">
                                <i class="fa-solid fa-clock-rotate-left"></i> å·²å„²å­˜çš„è¡Œç¨‹
                            </h3>
                            <div class="space-y-3 overflow-y-auto max-h-48 scrollbar-hide px-1" id="saved-trips-list">
                                ${state.savedTrips.length === 0 ? '<div class="text-xs text-orange-200 font-bold py-10">ç›®å‰æ²’æœ‰å„²å­˜ç´€éŒ„</div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('btn-new-trip').onclick = () => {
                state.step = 'setup';
                state.currentTripId = null;
                state.tripInfo = { destination: '', purpose: '', startDate: '', endDate: '', flightOut: '', flightIn: '' };
                state.hotels = [];
                render();
            };

            const list = document.getElementById('saved-trips-list');
            state.savedTrips.forEach(trip => {
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded-2xl shadow-sm border border-orange-100 text-left cursor-pointer hover:border-orange-300 transition-all group relative pr-10";
                item.innerHTML = `
                    <div class="text-sm font-bold text-gray-700 truncate">${trip.title}</div>
                    <div class="text-[10px] text-gray-400">${new Date(trip.updatedAt?.seconds * 1000).toLocaleDateString()}</div>
                    <button class="btn-delete-trip absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                item.onclick = () => {
                    state.tripInfo = trip.tripInfo;
                    state.hotels = trip.hotels;
                    state.itinerary = trip.itinerary;
                    state.currentTripId = trip.id;
                    state.step = 'dashboard';
                    render();
                };
                item.querySelector('.btn-delete-trip').onclick = async (e) => {
                    e.stopPropagation();
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'trips', trip.id));
                };
                list.appendChild(item);
            });
        }

        function renderSetup(container) {
            container.className = "min-h-screen bg-pink-50 p-6 flex items-center justify-center";
            container.innerHTML = `
                <div class="w-full max-w-md bg-white rounded-[40px] shadow-xl p-8 border-4 border-white relative">
                    <button id="back-to-landing" class="text-pink-300 flex items-center gap-1 mb-4 text-xs font-bold hover:text-pink-400">
                        <i class="fa-solid fa-xmark"></i> è¿”å›
                    </button>
                    <h1 class="text-3xl font-black text-pink-400 text-center mb-6 tracking-tight">æ—…ã®æº–å‚™</h1>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-location-dot"></i> ç›®çš„åœ°</label>
                            <input id="input-dest" value="${state.tripInfo.destination}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm" placeholder="æ±äº¬ã€äº¬éƒ½...">
                        </div>
                        <div>
                            <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-pen-to-square"></i> æ—…è¡Œç›®çš„</label>
                            <input id="input-purpose" value="${state.tripInfo.purpose}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm" placeholder="è³¼ç‰©èˆ‡ç¾é£Ÿä¹‹æ—…">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-calendar"></i> å‡ºç™¼</label>
                                <input type="date" id="input-start" value="${state.tripInfo.startDate}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-calendar-check"></i> å›ç¨‹</label>
                                <input type="date" id="input-end" value="${state.tripInfo.endDate}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-plane-departure"></i> å»ç¨‹èˆªç­</label>
                                <input id="input-flight-out" value="${state.tripInfo.flightOut}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm" placeholder="CX500">
                            </div>
                            <div>
                                <label class="block text-pink-500 font-bold mb-1 text-sm"><i class="fa-solid fa-plane-arrival"></i> å›ç¨‹èˆªç­</label>
                                <input id="input-flight-in" value="${state.tripInfo.flightIn}" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none focus:border-pink-300 text-sm" placeholder="CX501">
                            </div>
                        </div>
                    </div>

                    <button id="btn-to-hotels" class="w-full mt-8 bg-pink-400 text-white font-bold py-4 rounded-3xl shadow-lg active:scale-95 transition-all">ä¸‹ä¸€æ­¥ï¼šå®‰æ’ä½å®¿ âœ¨</button>
                </div>
            `;

            document.getElementById('back-to-landing').onclick = () => { state.step = 'landing'; render(); };
            document.getElementById('btn-to-hotels').onclick = () => {
                state.tripInfo.destination = document.getElementById('input-dest').value;
                state.tripInfo.purpose = document.getElementById('input-purpose').value;
                state.tripInfo.startDate = document.getElementById('input-start').value;
                state.tripInfo.endDate = document.getElementById('input-end').value;
                state.tripInfo.flightOut = document.getElementById('input-flight-out').value;
                state.tripInfo.flightIn = document.getElementById('input-flight-in').value;
                
                const start = new Date(state.tripInfo.startDate);
                const end = new Date(state.tripInfo.endDate);
                const count = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                if (isNaN(count) || count < 1) {
                    alert("è«‹é¸æ“‡æ­£ç¢ºæ—¥æœŸ");
                    return;
                }
                
                state.hotels = Array(count - 1).fill(null).map((_, i) => ({ night: i+1, name: '', isTBD: false }));
                state.step = 'hotels';
                render();
            };
        }

        function renderHotels(container) {
            container.className = "min-h-screen bg-pink-50 p-6 flex flex-col items-center";
            container.innerHTML = `
                <div class="w-full max-w-md">
                    <h2 class="text-2xl font-black text-pink-500 mb-6 flex items-center gap-2"><i class="fa-solid fa-hotel"></i> ä½å®¿å®‰æ’</h2>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto px-1 scrollbar-hide" id="hotels-list"></div>
                    <div class="flex gap-4 mt-8">
                        <button id="hotel-back" class="flex-1 bg-white text-pink-400 font-bold py-4 rounded-3xl border-2 border-pink-400">è¿”å›</button>
                        <button id="hotel-generate" class="flex-[2] bg-pink-400 text-white font-bold py-4 px-8 rounded-3xl shadow-lg">ç”Ÿæˆ AI è¡Œç¨‹ ğŸª„</button>
                    </div>
                </div>
            `;

            const list = document.getElementById('hotels-list');
            state.hotels.forEach((hotel, idx) => {
                const item = document.createElement('div');
                item.className = "bg-white p-5 rounded-[30px] shadow-sm border-2 border-pink-50 hover:border-pink-200 transition-all";
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-gray-600">ç¬¬ ${hotel.night} æ™šä½å®¿</span>
                        <label class="flex items-center gap-2 text-sm font-bold text-pink-400 cursor-pointer bg-pink-50 px-3 py-1 rounded-full">
                            <input type="checkbox" class="hotel-tbd-check" ${hotel.isTBD ? 'checked' : ''} class="accent-pink-400"> å¾…å®š
                        </label>
                    </div>
                    <input type="text" class="hotel-name-input w-full p-4 rounded-2xl bg-gray-50 border-none outline-none focus:ring-2 ring-pink-200 text-sm" 
                           placeholder="é…’åº—åç¨±" value="${hotel.name}" ${hotel.isTBD ? 'disabled' : ''}>
                `;
                item.querySelector('.hotel-tbd-check').onchange = (e) => {
                    state.hotels[idx].isTBD = e.target.checked;
                    if (e.target.checked) state.hotels[idx].name = '';
                    render();
                };
                item.querySelector('.hotel-name-input').oninput = (e) => {
                    state.hotels[idx].name = e.target.value;
                };
                list.appendChild(item);
            });

            document.getElementById('hotel-back').onclick = () => { state.step = 'setup'; render(); };
            document.getElementById('hotel-generate').onclick = () => generateItinerary();
        }

        function renderLoading(container) {
            container.className = "min-h-screen bg-pink-50 flex flex-col items-center justify-center text-center p-10";
            container.innerHTML = `
                <i class="fa-solid fa-plane-up text-pink-300 text-7xl animate-bounce-slow mb-6"></i>
                <h2 class="text-2xl font-black text-pink-500 animate-bounce tracking-tight">${state.loadingMsg}</h2>
                <p class="text-pink-300 mt-2 font-bold italic">æ­£åœ¨ç‚ºæ‚¨ç·¨æ’æœ€é †è·¯çš„å¤¢å¹»è¡Œç¨‹...</p>
            `;
        }

        function renderDashboard(container) {
            container.className = "flex-1 flex flex-col lg:flex-row overflow-hidden";
            
            // åœ°åœ– URL è¨ˆç®—
            let mapQuery = state.tripInfo.destination;
            let displayMode = "å…¨å¢ƒæ¦‚è¦½åœ–";
            
            if (state.selectedEvent) {
                mapQuery = `${state.selectedEvent.title}, ${state.tripInfo.destination}`;
                displayMode = state.selectedEvent.title;
            } else if (state.selectedDay) {
                const dayData = state.itinerary.days.find(d => d.dayNum === state.selectedDay);
                if (dayData && dayData.events.length > 0) {
                    const spots = dayData.events.filter(e => e.type !== 'flight').map(e => e.title);
                    if (spots.length > 1) {
                        const origin = encodeURIComponent(`${spots[0]}, ${state.tripInfo.destination}`);
                        const destination = encodeURIComponent(`${spots[spots.length - 1]}, ${state.tripInfo.destination}`);
                        const waypoints = spots.slice(1, -1).map(p => encodeURIComponent(`${p}, ${state.tripInfo.destination}`)).join('+to:');
                        mapQuery = `saddr=${origin}&daddr=${waypoints ? waypoints + '+to:' + destination : destination}`;
                        displayMode = `Day ${state.selectedDay} å®Œæ•´è·¯ç·š`;
                    } else {
                        mapQuery = `q=${encodeURIComponent(`${spots[0] || state.tripInfo.destination}`)}`;
                    }
                }
                displayMode = `Day ${state.selectedDay} è·¯ç·šé è¦½`;
            } else {
                mapQuery = `q=${encodeURIComponent(state.tripInfo.destination)}`;
            }
            
            const finalMapUrl = mapQuery.includes('saddr') 
                ? `https://maps.google.com/maps?${mapQuery}&t=&z=13&ie=UTF8&iwloc=&output=embed`
                : `https://maps.google.com/maps?q=${mapQuery}&t=&z=14&ie=UTF8&iwloc=&output=embed`;

            container.innerHTML = `
                <!-- å·¦å´åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto p-4 lg:p-8 space-y-6 scrollbar-hide relative bg-pink-50">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <div class="flex items-center gap-4">
                                <button id="btn-exit" class="p-2 bg-white rounded-full text-pink-400 shadow-sm hover:bg-pink-50"><i class="fa-solid fa-xmark"></i></button>
                                <h1 class="text-4xl font-black text-pink-500 tracking-tight">${state.tripInfo.destination}</h1>
                            </div>
                            <p class="text-xs font-bold text-pink-300 mt-2 ml-14 uppercase">${state.tripInfo.startDate} ~ ${state.tripInfo.endDate}</p>
                        </div>
                        <div class="bg-white p-4 rounded-[25px] shadow-sm flex items-center gap-4 border border-pink-100">
                            <i class="fa-solid fa-sun text-yellow-400 text-2xl"></i>
                            <div class="text-2xl font-black text-gray-700">22Â°C</div>
                        </div>
                    </header>

                    <div id="itinerary-days" class="space-y-12 pb-20"></div>
                </div>

                <!-- å³å´åœ°åœ– -->
                <div class="w-full lg:w-[480px] bg-white border-l-4 border-pink-100 flex flex-col relative h-[50vh] lg:h-full shadow-2xl">
                    <div class="p-6 bg-pink-400 text-white flex justify-between items-center shadow-lg z-20">
                        <span class="font-black text-lg flex items-center gap-2 truncate pr-2">
                            <i class="fa-solid fa-location-arrow ${state.selectedDay || state.selectedEvent ? 'animate-bounce' : ''}"></i> 
                            ${displayMode}
                        </span>
                        ${(state.selectedDay || state.selectedEvent) ? `
                            <button id="btn-reset-map" class="bg-white/30 px-4 py-2 rounded-2xl text-xs font-black hover:bg-white/40 whitespace-nowrap">æ¢å¾©å…¨è¦½</button>
                        ` : ''}
                    </div>
                    <div class="flex-1 bg-gray-100 relative">
                        <iframe width="100%" height="100%" style="border:0" loading="lazy" src="${finalMapUrl}"></iframe>
                        <div class="absolute top-4 left-4 right-4 bg-white/70 backdrop-blur-md p-3 rounded-2xl shadow-sm border border-white/50 pointer-events-none">
                            <p class="text-[10px] text-gray-600 font-black uppercase text-center tracking-widest">
                                ${state.selectedDay ? 'ğŸ“ æ­£åœ¨é¡¯ç¤ºè©²æ—¥å°èˆªè·¯ç·š' : 'ğŸ—ºï¸ é»æ“Šè¡Œç¨‹æ¨™é¡Œæˆ–åœ°é»æŸ¥çœ‹è·¯ç·š'}
                            </p>
                        </div>
                    </div>
                    
                    ${state.itinerary.hotelSuggestions ? `
                        <div class="p-4 bg-indigo-50/95 backdrop-blur-sm border-t border-indigo-100 h-40 overflow-y-auto scrollbar-hide">
                            <h4 class="text-[10px] font-black text-indigo-400 uppercase mb-3 flex items-center gap-2">ä½å®¿æ¨è–¦</h4>
                            <div class="space-y-3" id="hotel-suggestions"></div>
                        </div>
                    ` : ''}
                </div>
            `;

            // ç¶å®šåŸºç¤æŒ‰éˆ•
            document.getElementById('btn-exit').onclick = () => { state.step = 'landing'; render(); };
            if (document.getElementById('btn-reset-map')) {
                document.getElementById('btn-reset-map').onclick = () => { state.selectedDay = null; state.selectedEvent = null; render(); };
            }

            // æ¸²æŸ“æ¯æ—¥è¡Œç¨‹
            const daysContainer = document.getElementById('itinerary-days');
            state.itinerary.days.forEach((day, dIdx) => {
                const dayWrapper = document.createElement('div');
                dayWrapper.className = `transition-all duration-500 ${state.selectedDay && state.selectedDay !== day.dayNum ? 'opacity-30 blur-[1px]' : ''}`;
                
                dayWrapper.innerHTML = `
                    <div class="flex items-center gap-4 mb-6 cursor-pointer group day-title-btn">
                        <div class="w-14 h-14 rounded-[20px] flex items-center justify-center text-white font-black text-2xl shadow-lg transition-transform group-hover:rotate-6 ${day.dayNum % 2 === 0 ? 'bg-orange-300' : 'bg-pink-400'}">
                            ${day.dayNum}
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-gray-700 group-hover:text-pink-400">Day ${day.dayNum} è¡Œç¨‹</h3>
                            <p class="text-[10px] font-bold uppercase ${state.selectedDay === day.dayNum ? 'text-pink-400' : 'text-pink-200'}">
                                ${state.selectedDay === day.dayNum ? 'â— æ­£åœ¨æŸ¥çœ‹å–®æ—¥è·¯ç·š' : 'â—‹ é»æ“ŠæŸ¥çœ‹è·¯ç·šåœ–'}
                            </p>
                        </div>
                    </div>
                    <div class="space-y-6 ml-7 border-l-4 border-dashed border-pink-100 pl-8 pb-4 day-events-container"></div>
                `;

                dayWrapper.querySelector('.day-title-btn').onclick = () => {
                    state.selectedDay = state.selectedDay === day.dayNum ? null : day.dayNum;
                    state.selectedEvent = null;
                    render();
                };

                const eventsContainer = dayWrapper.querySelector('.day-events-container');
                day.events.forEach((event, eIdx) => {
                    const eventCard = document.createElement('div');
                    eventCard.className = `bg-white p-6 rounded-[32px] shadow-sm relative border-2 transition-all cursor-pointer group ${state.selectedEvent === event ? 'border-pink-400 scale-[1.02] shadow-md z-10' : 'border-transparent hover:border-pink-100'}`;
                    eventCard.innerHTML = `
                        <div class="absolute -left-[45px] top-6 w-6 h-6 bg-white border-4 border-pink-300 rounded-full z-10"></div>
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-xl ${event.type === 'meal' ? 'bg-orange-50 text-orange-400' : 'bg-pink-50 text-pink-400'}">
                                    <i class="fa-solid ${event.type === 'meal' ? 'fa-utensils' : (event.type === 'flight' ? 'fa-plane' : 'fa-map-pin')} text-lg"></i>
                                </div>
                                <div>
                                    <span class="font-black text-gray-700 text-lg">${event.title}</span>
                                    <span class="ml-2 text-[10px] font-bold bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full">${event.time}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100">
                                <button class="btn-move-up p-1 hover:text-pink-400"><i class="fa-solid fa-chevron-up"></i></button>
                                <button class="btn-move-down p-1 hover:text-pink-400"><i class="fa-solid fa-chevron-down"></i></button>
                                <button class="btn-del-event p-1 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 leading-relaxed">${event.desc}</p>
                    `;
                    
                    eventCard.onclick = (e) => {
                        e.stopPropagation();
                        state.selectedEvent = state.selectedEvent === event ? null : event;
                        render();
                    };

                    // ç¶å®šç·¨è¼¯åŠŸèƒ½
                    eventCard.querySelector('.btn-move-up').onclick = (e) => {
                        e.stopPropagation();
                        if (eIdx > 0) {
                            [day.events[eIdx], day.events[eIdx-1]] = [day.events[eIdx-1], day.events[eIdx]];
                            saveTripToCloud().then(render);
                        }
                    };
                    eventCard.querySelector('.btn-move-down').onclick = (e) => {
                        e.stopPropagation();
                        if (eIdx < day.events.length - 1) {
                            [day.events[eIdx], day.events[eIdx+1]] = [day.events[eIdx+1], day.events[eIdx]];
                            saveTripToCloud().then(render);
                        }
                    };
                    eventCard.querySelector('.btn-del-event').onclick = (e) => {
                        e.stopPropagation();
                        day.events.splice(eIdx, 1);
                        saveTripToCloud().then(render);
                    };

                    eventsContainer.appendChild(eventCard);
                });

                // æ–°å¢æŒ‰éˆ•
                const addBtn = document.createElement('button');
                addBtn.className = "flex items-center gap-2 text-pink-400 font-black text-sm hover:translate-x-1 transition-transform bg-white/80 px-4 py-3 rounded-full border border-pink-100 shadow-sm";
                addBtn.innerHTML = `<i class="fa-solid fa-plus"></i> æ–°å¢æ™¯é»`;
                addBtn.onclick = () => {
                    state.activeDayToAdd = dIdx;
                    state.showAddModal = true;
                    render();
                };
                eventsContainer.appendChild(addBtn);

                daysContainer.appendChild(dayWrapper);
            });

            // æ¸²æŸ“ä½å®¿å»ºè­°
            const hotelSugg = document.getElementById('hotel-suggestions');
            if (hotelSugg) {
                state.itinerary.hotelSuggestions.forEach(h => {
                    const hCard = document.createElement('div');
                    hCard.className = "bg-white p-4 rounded-3xl text-[10px] font-bold text-indigo-600 shadow-sm border border-indigo-100";
                    hCard.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-black text-indigo-500 text-xs">ğŸ¨ ${h.recommendations || h}</span>
                            <span class="bg-indigo-50 px-2 py-0.5 rounded-full text-[9px]">${h.area || ''}</span>
                        </div>
                        <p class="text-[9px] text-gray-400 italic">ã€Œ${h.reason || ''}ã€</p>
                    `;
                    hotelSugg.appendChild(hCard);
                });
            }

            // å¦‚æœæœ‰å½ˆçª—
            if (state.showAddModal) renderModal(container);
        }

        function renderModal(container) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-pink-400/20 backdrop-blur-md z-50 flex items-center justify-center p-6";
            modal.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-[50px] p-10 shadow-2xl border-4 border-white">
                    <h3 class="text-2xl font-black text-pink-400 mb-6 flex items-center gap-2">æ–°å¢è¡Œç¨‹ âœ¨</h3>
                    <div class="space-y-4">
                        <input id="modal-title" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none text-sm" placeholder="æ™¯é»åç¨±">
                        <input id="modal-time" type="time" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none text-sm" value="12:00">
                        <textarea id="modal-desc" class="w-full p-3 rounded-2xl border-2 border-pink-100 outline-none text-sm h-24" placeholder="ç°¡ä»‹..."></textarea>
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button id="modal-cancel" class="flex-1 bg-gray-100 text-gray-400 font-bold py-4 rounded-3xl">å–æ¶ˆ</button>
                        <button id="modal-save" class="flex-1 bg-pink-400 text-white font-bold py-4 rounded-3xl shadow-lg">æ·»åŠ </button>
                    </div>
                </div>
            `;
            modal.querySelector('#modal-cancel').onclick = () => { state.showAddModal = false; render(); };
            modal.querySelector('#modal-save').onclick = () => {
                const title = document.getElementById('modal-title').value;
                const time = document.getElementById('modal-time').value;
                const desc = document.getElementById('modal-desc').value;
                if (title) {
                    state.itinerary.days[state.activeDayToAdd].events.push({ title, time, desc, type: 'attraction', lat: 0, lng: 0 });
                    saveTripToCloud().then(() => {
                        state.showAddModal = false;
                        render();
                    });
                }
            };
            container.appendChild(modal);
        }

        // --- å•Ÿå‹•ç¨‹åº ---
        window.onload = async () => {
            await initAuth();
            setupListeners();
            render();
        };

    </script>
</body>
</html>